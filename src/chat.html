<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/igv@2.10.1/dist/igv.min.js"></script>
  </head>
  <body>
    <div id="igvDiv" style="height:400px; max-height:400px !important; padding-top: 10px;padding-bottom: 10px; border:1px solid lightgray"></div>



<script type="text/javascript">
  var options =
      {
          // Example of fully specifying a reference .  We could alternatively use  "genome: 'hg19'"
          reference:
              {
                  id: "hg19",
                  fastaURL: "https://s3.amazonaws.com/igv.broadinstitute.org/genomes/seq/1kg_v37/human_g1k_v37_decoy.fasta",
                  cytobandURL: "https://s3.amazonaws.com/igv.broadinstitute.org/genomes/seq/b37/b37_cytoband.txt"
              },
          locus: "8:128,750,948-128,751,025",
          tracks:
              [
                  {
                      name: "Phase 3 WGS variants",
                      type: "variant",
                      format: "vcf",
                      url: "https://s3.amazonaws.com/1000genomes/release/20130502/ALL.wgs.phase3_shapeit2_mvncall_integrated_v5b.20130502.sites.vcf.gz",
                      indexURL: "https://s3.amazonaws.com/1000genomes/release/20130502/ALL.wgs.phase3_shapeit2_mvncall_integrated_v5b.20130502.sites.vcf.gz.tbi"
                  },
                  {
                      type: 'alignment',
                      format: 'cram',
                      url: 'https://s3.amazonaws.com/1000genomes/phase3/data/HG00096/exome_alignment/HG00096.mapped.ILLUMINA.bwa.GBR.exome.20120522.bam.cram',
                      indexURL: 'https://s3.amazonaws.com/1000genomes/phase3/data/HG00096/exome_alignment/HG00096.mapped.ILLUMINA.bwa.GBR.exome.20120522.bam.cram.crai',
                      name: 'HG00096',
                      sort: {
                          chr: "chr8",
                          position: 128750986,
                          option: "BASE",
                          direction: "ASC"
                      },
                      height: 600
                  },

                  {
                      name: "Genes",
                      type: "annotation",
                      format: "bed",
                      url: "https://s3.amazonaws.com/igv.broadinstitute.org/annotations/hg19/genes/refGene.hg19.bed.gz",
                      indexURL: "https://s3.amazonaws.com/igv.broadinstitute.org/annotations/hg19/genes/refGene.hg19.bed.gz.tbi",
                      order: Number.MAX_VALUE,
                      visibilityWindow: 300000000,
                      displayMode: "EXPANDED"
                  }
              ]

      };


let currentWebSocket = null;
let username = "robert";
let roomname = "test";
let hostname = window.location.host;
let lastSeenTimestamp = 0;

function join() {
  let ws = new WebSocket("wss://" + hostname + "/api/room/" + roomname + "/websocket");
  let rejoined = false;
  let startTime = Date.now();

  let rejoin = async () => {
    if (!rejoined) {
      rejoined = true;
      currentWebSocket = null;

      // Don't try to reconnect too rapidly.
      let timeSinceLastJoin = Date.now() - startTime;
      if (timeSinceLastJoin < 10000) {
        // Less than 10 seconds elapsed since last join. Pause a bit.
        await new Promise(resolve => setTimeout(resolve, 10000 - timeSinceLastJoin));
      }

      // OK, reconnect now!
      join();
    }
  }

  ws.addEventListener("open", event => {
    currentWebSocket = ws;

    // Send user info message.
    ws.send(JSON.stringify({ name: username }));
  });

  ws.addEventListener("message", event => {
    let data = JSON.parse(event.data);

    if (data.error) {
      addChatMessage(null, "* Error: " + data.error);
    } else if (data.joined) {
      console.warn("JOINED", data);
    } else if (data.quit) {
      console.warn("QUIT", data);
    } else if (data.ready) {
      // // All pre-join messages have been delivered.
      // if (!wroteWelcomeMessages) {
      //   wroteWelcomeMessages = true;
      // }
    } else {
      // A regular chat message.
      if (data.timestamp > lastSeenTimestamp) {
        addChatMessage(data.name, data.message);
        lastSeenTimestamp = data.timestamp;
      }
    }
  });

  ws.addEventListener("close", event => {
    console.log("WebSocket closed, reconnecting:", event.code, event.reason);
    rejoin();
  });
  ws.addEventListener("error", event => {
    console.log("WebSocket error, reconnecting:", event);
    rejoin();
  });
}

function addChatMessage(name, text) {
  console.log(name, text);
}

join();
</script>
</html>
